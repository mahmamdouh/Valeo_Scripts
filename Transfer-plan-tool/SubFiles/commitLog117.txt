b'commit 286232039e6e2c530ced4aea1692ee2814e5850f
Author: Andras GUGAN (JV EXT) <andras.gugan.jv.ext@valeo.com>
Date:   Wed Dec 1 10:04:25 2021 +0100

    $100kW-45103$ - [SWT] B01: SimuDrvCtrl not reacting on Idq setpoint changes
    
    Change-Id: I3afe739f371ae69a6856170abca247bc96ef2e63

diff --git a/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/include/DrvCtrlSimn_UsrData.h b/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/include/DrvCtrlSimn_UsrData.h
index 419e953ce..8c87d4b09 100644
--- a/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/include/DrvCtrlSimn_UsrData.h
+++ b/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/include/DrvCtrlSimn_UsrData.h
@@ -105,19 +105,12 @@ typedef struct {
 /*================== [declaration of public data] ===========================*/
 #define DRVCTRLSIMN_START_SEC_VAR_INIT_32
 #include "MemMap.h"
-EXTERNAL_ VAR(SimuDrvCtrl_OutputDataType, DRVCTRLSIMN_VAR) SimuDrvCtrl_OutputData;
-#define DRVCTRLSIMN_STOP_SEC_VAR_INIT_32
-#include "MemMap.h"
 
-
-#define DRVCTRLSIMN_START_SEC_CALIB_32
-#include "MemMap.h"
-EXTERNAL_ CONST(SimuDrvCtrl_InputDataType, DRVCTRLSIMN_CALIB) SimuDrvCtrl_InputData;
-EXTERNAL_ CONST(SimuEnc_InputDataType, DRVCTRLSIMN_CALIB) SimuEnc_InputData;
-#define DRVCTRLSIMN_STOP_SEC_CALIB_32
+extern VAR(SimuDrvCtrl_InputDataType, DRVCTRLSIMN_VAR) SimuDrvCtrl_InputData;
+extern VAR(SimuDrvCtrl_OutputDataType, DRVCTRLSIMN_VAR) SimuDrvCtrl_OutputData;
+extern VAR(SimuEnc_InputDataType, DRVCTRLSIMN_VAR) SimuEnc_InputData;
+#define DRVCTRLSIMN_STOP_SEC_VAR_INIT_32
 #include "MemMap.h"
-
-
 #endif /*SERIES_PRODUCTION*/
 
 /*================== [closure] ==============================================*/
diff --git a/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn.c b/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn.c
index b04de1a5a..d9f591687 100644
--- a/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn.c
+++ b/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn.c
@@ -140,7 +140,7 @@ STATIC FUNC(void, DRVCTRLSIMN_CODE) DrvCtrlSimn_RunSpt(void)
 
    /* reset trigger when ramping is finished
     * (for compatibility use SimuDrvCtrl_InputData.SetptTrigger as feedback signal) */
-   if((0U != SimuDrvCtrl_InputData.SetptTrigger) && (FALSE == IdIqReqMuxRampActv))
+   if((0U != SimuDrvCtrl_InputData.SetptTrigger) && (FALSE == IdIqReqMuxRampActv) && (DRVCTRL_VLTG_SPTMODE_UDUQ != SimuDrvCtrl_InputData.SimulationActive))
    {
       *((uint32*) &(SimuDrvCtrl_InputData.SetptTrigger)) = 0U; /*PRQA S 0311*/ /*  varaiable is located in overlay RAM so writing on a CONST is possible. The cast is nessesary to supress compiler error */
    }
diff --git a/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn_UsrData.c b/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn_UsrData.c
index 2bc6ed8ac..61da63635 100644
--- a/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn_UsrData.c
+++ b/src/fw_cu/Components/Inv/Simn/DrvCtrlSimn/src/DrvCtrlSimn_UsrData.c
@@ -30,12 +30,12 @@
 /*================== [type definitions] =====================================*/
 
 /*================== [global data] ===========================================*/
-#define DRVCTRLSIMN_START_SEC_CALIB_32
+#define DRVCTRLSIMN_START_SEC_VAR_INIT_32
 /*lint -e(537,451) Repeated inclusion is needed. */
 #include "MemMap.h"
 /* input data structure of Drive Control - simulation mode use iq/id instead of TRQ setpoint value  */
 /* !struct SimuDrvCtrl_InputDataType */
-CONST(SimuDrvCtrl_InputDataType, DRVCTRLSIMN_CALIB) SimuDrvCtrl_InputData = {
+VAR(SimuDrvCtrl_InputDataType, DRVCTRLSIMN_VAR) SimuDrvCtrl_InputData = {
 /*
  @@ ELEMENT = SimulationActive
  @@ STRUCTURE = SimuDrvCtrl_InputDataType
@@ -236,7 +236,7 @@ CONST(SimuDrvCtrl_InputDataType, DRVCTRLSIMN_CALIB) SimuDrvCtrl_InputData = {
  @@ STRUCTURE = SimuDrvCtrl_InputDataType
  @@ END
  */
-#define DRVCTRLSIMN_STOP_SEC_CALIB_32
+#define DRVCTRLSIMN_STOP_SEC_VAR_INIT_32
 /*lint -e(537,451) Repeated inclusion is needed. */
 #include "MemMap.h"
 
@@ -325,11 +325,11 @@ VAR(SimuDrvCtrl_OutputDataType, DRVCTRLSIMN_VAR) SimuDrvCtrl_OutputData = {
 /*lint -e(537,451) Repeated inclusion is needed. */
 #include "MemMap.h"
 
-#define DRVCTRLSIMN_START_SEC_CALIB_32
+#define DRVCTRLSIMN_START_SEC_VAR_INIT_32
 /*lint -e(537,451) Repeated inclusion is needed. */
 #include "MemMap.h"
 /* Drive Control - simulation mode use Encoder angle/speed instead of encoder value */
-CONST(SimuEnc_InputDataType, DRVCTRLSIMN_CALIB) SimuEnc_InputData = {
+VAR(SimuEnc_InputDataType, DRVCTRLSIMN_VAR) SimuEnc_InputData = {
 /*
  @@ ELEMENT = SimulationActive
  @@ STRUCTURE = SimuEnc_InputDataType
@@ -369,7 +369,7 @@ CONST(SimuEnc_InputDataType, DRVCTRLSIMN_CALIB) SimuEnc_InputData = {
  @@ STRUCTURE = SimuEnc_InputDataType
  @@ END
  */
-#define DRVCTRLSIMN_STOP_SEC_CALIB_32
+#define DRVCTRLSIMN_STOP_SEC_VAR_INIT_32
 /*lint -e(537,451) Repeated inclusion is needed. */
 #include "MemMap.h"
 #endif /*SERIES_PRODUCTION*/
'
