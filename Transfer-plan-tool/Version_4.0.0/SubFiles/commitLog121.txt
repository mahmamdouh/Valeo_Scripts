b'commit 6774e1358d74781403bb5dce03cf15054237d4e0
Author: Emerson-Hai ZHAO (JV) <emerson-hai.zhao.jv@valeo.com>
Date:   Mon Nov 29 14:07:48 2021 +0800

    $100kW-43910$ - [SWT] B01 : DEMs Monitors are inactive (Activation Criteria "none")
    
    Change-Id: Ic577db4509999a85c92cf9fb5253ea6f3b733e8a

diff --git a/src/fw_cu/Components/Cmn/MngFlts/ErrDeb/src/ErrDeb_cfg.c b/src/fw_cu/Components/Cmn/MngFlts/ErrDeb/src/ErrDeb_cfg.c
index 8cb1ec941..ac3f39bb1 100644
--- a/src/fw_cu/Components/Cmn/MngFlts/ErrDeb/src/ErrDeb_cfg.c
+++ b/src/fw_cu/Components/Cmn/MngFlts/ErrDeb/src/ErrDeb_cfg.c
@@ -83,6 +83,7 @@
 #include "SftyE2eRx_cfg.h"
 #include "SftyTqMon.h"
 #include "SftyModMgr.h"
+#include "SftyInvActr.h"
 #include "Dem.h"
 #include "Dem_IntErrId.h"
 #include "Dem_IntEvtId.h"
@@ -2258,7 +2259,7 @@ CONST(ErrDeb_FltCfgType, ERRDEB_CONST) ErrDebFltCfg[ERR_DEB_FLT_CNT] =
       &ErrDebFltData_MID_POINT_U, /* Fault data */
       &SftyInvActrMidPointPhaUErrMonrSt, /* Direct pointer to monitor status */
       NULL_PTR, /* Status update function used if MonrStsPtr == NULL_PTR */
-      NULL_PTR, /* Monitor init function */
+      &SftyInvActr_ReinitMonrData, /* Monitor init function */
       FCT_ID_LOCK_MID_POINT_U, /* FID for fault locking */
       DemConf_DemEventParameter_MID_POINT_U, /* Dem paramter configured */
       DEM_EVENT_ID_INVALID 
@@ -2268,7 +2269,7 @@ CONST(ErrDeb_FltCfgType, ERRDEB_CONST) ErrDebFltCfg[ERR_DEB_FLT_CNT] =
       &ErrDebFltData_MID_POINT_V, /* Fault data */
       &SftyInvActrMidPointPhaVErrMonrSt, /* Direct pointer to monitor status */
       NULL_PTR, /* Status update function used if MonrStsPtr == NULL_PTR */
-      NULL_PTR, /* Monitor init function */
+      &SftyInvActr_ReinitMonrData, /* Monitor init function */
       FCT_ID_LOCK_MID_POINT_V, /* FID for fault locking */
       DemConf_DemEventParameter_MID_POINT_V, /* Dem paramter configured */
       DEM_EVENT_ID_INVALID 
@@ -2278,7 +2279,7 @@ CONST(ErrDeb_FltCfgType, ERRDEB_CONST) ErrDebFltCfg[ERR_DEB_FLT_CNT] =
       &ErrDebFltData_MID_POINT_W, /* Fault data */
       &SftyInvActrMidPointPhaWErrMonrSt, /* Direct pointer to monitor status */
       NULL_PTR, /* Status update function used if MonrStsPtr == NULL_PTR */
-      NULL_PTR, /* Monitor init function */
+      &SftyInvActr_ReinitMonrData, /* Monitor init function */
       FCT_ID_LOCK_MID_POINT_W, /* FID for fault locking */
       DemConf_DemEventParameter_MID_POINT_W, /* Dem paramter configured */
       DEM_EVENT_ID_INVALID 
@@ -2288,7 +2289,7 @@ CONST(ErrDeb_FltCfgType, ERRDEB_CONST) ErrDebFltCfg[ERR_DEB_FLT_CNT] =
       &ErrDebFltData_INV_GATE_DRVR_HI_HWP, /* Fault data */
       NULL_PTR,/*&SftyInvActrHSGateDrvrMonrSt, / * Direct pointer to monitor status */
       NULL_PTR, /* Status update function used if MonrStsPtr == NULL_PTR */
-      NULL_PTR, /* Monitor init function */
+      &SftyInvActr_ReinitMonrData, /* Monitor init function */
       FCT_ID_LOCK_INV_GATE_DRVR_HI_HWP, /* FID for fault locking */
       DemConf_DemEventParameter_INV_GATE_DRVR_HI_HWP, /* Dem paramter configured */
       DEM_EVENT_ID_INVALID 
@@ -2298,7 +2299,7 @@ CONST(ErrDeb_FltCfgType, ERRDEB_CONST) ErrDebFltCfg[ERR_DEB_FLT_CNT] =
       &ErrDebFltData_INV_GATE_DRVR_LO_HWP, /* Fault data */
       NULL_PTR,/*&SftyInvActrLoGateDrvrMonrSt, / * Direct pointer to monitor status */
       NULL_PTR, /* Status update function used if MonrStsPtr == NULL_PTR */
-      NULL_PTR, /* Monitor init function */
+      &SftyInvActr_ReinitMonrData, /* Monitor init function */
       FCT_ID_LOCK_INV_GATE_DRVR_LO_HWP, /* FID for fault locking */
       DemConf_DemEventParameter_INV_GATE_DRVR_LO_HWP, /* Dem paramter configured */
       DEM_EVENT_ID_INVALID 
diff --git a/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvDcUEvln/src/SftyHvDcUEvln.c b/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvDcUEvln/src/SftyHvDcUEvln.c
index 05ba7339a..8dc853d1b 100644
--- a/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvDcUEvln/src/SftyHvDcUEvln.c
+++ b/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvDcUEvln/src/SftyHvDcUEvln.c
@@ -460,6 +460,8 @@ LOCAL_INLINE SftyHvDcUEvlnRngErrMonStType SftyHvDcUEvln_ChkRngDrvBd(void)
    /* ************* Source code **************** */
 
    /* Range High Check */
+   /* TODO: Activation Criteria\' in fault matrix needs to be update */
+#if 0   
    if (SftyHvDcUEvlnDrvBdE2eFpgaRxCrcErrMonrSt == ERR_DEB_MONR_STS_PASSED)
    \t{
       if (SftyHvDcUEvlnDrvBdUdcVal >= SftyHvDcUEvlnDrvBdUdcRngHiThd)
@@ -477,9 +479,25 @@ LOCAL_INLINE SftyHvDcUEvlnRngErrMonStType SftyHvDcUEvln_ChkRngDrvBd(void)
    {
       retVal.RngHi = ERR_DEB_MONR_STS_INACTIVE;
    }
-\t  
+#else
+
+   if (SftyHvDcUEvlnDrvBdUdcVal >= SftyHvDcUEvlnDrvBdUdcRngHiThd)
+   {
+      /* Value is higher than allowed */
+      retVal.RngHi = ERR_DEB_MONR_STS_FAILED;
+   }
+   else
+   {
+      /* No error */
+      retVal.RngHi = ERR_DEB_MONR_STS_PASSED;
+   }
+
+#endif
+
 
    /* Range Low Check */
+   /* TODO: Activation Criteria\' in fault matrix needs to be update */
+#if 0
    if ((SftyHvDcUEvlnDrvBdE2eFpgaRxCrcErrMonrSt  == ERR_DEB_MONR_STS_PASSED)   &&
    \t   (SftyHvDcUEvlnDrvBdPwrSplyP16Prsnt        == TRUE))
    {   
@@ -498,7 +516,20 @@ LOCAL_INLINE SftyHvDcUEvlnRngErrMonStType SftyHvDcUEvln_ChkRngDrvBd(void)
    {
       retVal.RngLo = ERR_DEB_MONR_STS_INACTIVE;
    }
-   
+#else
+
+   if (SftyHvDcUEvlnDrvBdUdcVal <= SftyHvDcUEvlnDrvBdUdcRngLoThd)
+   {
+      /* Value is lower than allowed */
+      retVal.RngLo = ERR_DEB_MONR_STS_FAILED;
+   }
+   else
+   {
+      /* No error */
+      retVal.RngLo = ERR_DEB_MONR_STS_PASSED;
+   }
+
+#endif   
    
    return retVal;
 }
@@ -525,8 +556,10 @@ LOCAL_INLINE SftyHvDcUEvlnRngErrMonStType SftyHvDcUEvln_ChkRngCtrlBd(void)
    /* ************* Source code **************** */
 
    /* Range High Check */
+   /* TODO: Activation Criteria\' in fault matrix needs to be update */
+#if 0
    if (SftyHvDcUEvlnCtrlBdE2eFpgaRxCrcErrMonrSt == ERR_DEB_MONR_STS_PASSED)
-   {   
+   {
       if (SftyHvDcUEvlnCtrlBdUdcVal >= SftyHvDcUEvlnCtrlBdUdcRngHiThd)
       {
          /* Value is higher than allowed */
@@ -542,9 +575,24 @@ LOCAL_INLINE SftyHvDcUEvlnRngErrMonStType SftyHvDcUEvln_ChkRngCtrlBd(void)
    {
       retVal.RngHi = ERR_DEB_MONR_STS_INACTIVE;
    } 
+#else
+
+   if (SftyHvDcUEvlnCtrlBdUdcVal >= SftyHvDcUEvlnCtrlBdUdcRngHiThd)
+   {
+      /* Value is higher than allowed */
+      retVal.RngHi = ERR_DEB_MONR_STS_FAILED;
+   }
+   else
+   {
+      /* No error */
+      retVal.RngHi = ERR_DEB_MONR_STS_PASSED;
+   }
 
+#endif
 
    /* Range Low Check */
+   /* TODO: Activation Criteria\' in fault matrix needs to be update */
+#if 0
    if ((SftyHvDcUEvlnCtrlBdE2eFpgaRxCrcErrMonrSt == ERR_DEB_MONR_STS_PASSED)   &&
 \t   (SftyHvDcUEvlnCtrlBdPwrSplyP16Prsnt       == TRUE))
    \t{
@@ -563,7 +611,20 @@ LOCAL_INLINE SftyHvDcUEvlnRngErrMonStType SftyHvDcUEvln_ChkRngCtrlBd(void)
    {
       retVal.RngLo = ERR_DEB_MONR_STS_INACTIVE;
    }
-   
+#else
+
+   if (SftyHvDcUEvlnCtrlBdUdcVal <= SftyHvDcUEvlnCtrlBdUdcRngLoThd)
+   {
+      /* Value is lower than allowed */
+      retVal.RngLo = ERR_DEB_MONR_STS_FAILED;
+   }
+   else
+   {
+      /* No error */
+      retVal.RngLo = ERR_DEB_MONR_STS_PASSED;
+   }
+
+#endif   
    
    return retVal;
 }
diff --git a/src/fw_cu/Components/Safety/Sfty_Inv/SftyInvActr/src/SftyInvActr.c b/src/fw_cu/Components/Safety/Sfty_Inv/SftyInvActr/src/SftyInvActr.c
index 19edaeadf..0b1e0e021 100644
--- a/src/fw_cu/Components/Safety/Sfty_Inv/SftyInvActr/src/SftyInvActr.c
+++ b/src/fw_cu/Components/Safety/Sfty_Inv/SftyInvActr/src/SftyInvActr.c
@@ -105,7 +105,7 @@ LOCAL_INLINE void SftyInvActr_GetInputData(void)
 
    /* 1> Read Safe State Request that is from SftyErrDeb module */
 
-   #ifndef SERIES_PRODUCTION
+#ifndef SERIES_PRODUCTION
 
    if (SftyReplcmtInvActrSafeStReqSftyStiEna == TRUE)
    {
@@ -121,15 +121,14 @@ LOCAL_INLINE void SftyInvActr_GetInputData(void)
    {
       SftyInvActrFctldHsAscSfty         = (boolean)(SftyErrDebFctInhbnSts.B.FctIdHsAsc);
 \t  SftyInvActrFctldLsAscSfty         = (boolean)(SftyErrDebFctInhbnSts.B.FctIdLsAsc);
-\t  SftyInvActrFctldSpoSfty           = FALSE;   /* (boolean)(SftyErrDebFctInhbnSts.B.FctIdSpoSfty) */
+\t  SftyInvActrFctldSpoSfty           = (boolean)(SftyErrDebFctInhbnSts.B.FctIdSpo);
 \t  SftyInvActrFctldCoordHsAscSpoSfty = (boolean)(SftyErrDebFctInhbnSts.B.FctIdCoordHsAscSpo);
 \t  SftyInvActrFctldCoordLsAscSpoSfty = (boolean)(SftyErrDebFctInhbnSts.B.FctIdCoordLsAscSpo);
    }
 
-
    /* 2> Read Safe State Request that is from DrvCtrl module */
 
-  #ifndef SERIES_PRODUCTION
+#ifndef SERIES_PRODUCTION
 
    if (SftyReplcmtInvActrSafeStReqDrvStiEna == TRUE)
    {
@@ -153,7 +152,7 @@ LOCAL_INLINE void SftyInvActr_GetInputData(void)
    }
    else
 \t   
-   #endif /* SERIES_PRODUCTION */
+#endif /* SERIES_PRODUCTION */
 
    {      
       SftyInvActrMotorSpdFild = DrvCtrlC2cData.SpdMeclRpmFild1;   /* SftyRslvrCalcnMeclSpdFild */ 
@@ -173,7 +172,7 @@ LOCAL_INLINE void SftyInvActr_GetInputData(void)
    }
    else
    
-   #endif /* SERIES_PRODUCTION */
+#endif /* SERIES_PRODUCTION */
 
    {  \t
 \t  SftyInvActrHSGateDrvrErrMonrSt   = IgbtErrMonitorStMap[SftyE2eFpgaHsGateDrvrFltSts & (0x01U)];
@@ -195,7 +194,7 @@ LOCAL_INLINE void SftyInvActr_GetInputData(void)
    }
    else
 \t   
-   #endif /* SERIES_PRODUCTION */
+#endif /* SERIES_PRODUCTION */
 
    {    
       SftyInvActrEmgySwFltSts     = SftyE2eFpgaEmgySWFltSts;
@@ -276,7 +275,7 @@ LOCAL_INLINE uint8 SftyInvActr_GetSafeStReqSfty(void)
 /******************************************************************/
 LOCAL_INLINE void SftyInvActr_DetmnSafeStReq(void)
 {
-   /* ******** Variables declaration *********** */      
+   /* ******** Variables declaration *********** */
    uint8 SafeStReqSSW;\t /* Safe state request from SSW module */
    
    /* ************* Source code **************** */
@@ -589,7 +588,7 @@ if((SWIT_SftyInvActr_EN_KEY==SWIT_First_HookEnableKey))
  * \\return  None
  */
 /******************************************************************/
-FUNC(void, SFTY_INV_ACTR_CODE) SftyInvActr_ReinitMonrData(void)   /* PRQA S 1503 # SftyInvActr_ReinitMonrData() will be called by ErrDeb_cfg.c, but it\'s configured by BSW! */
+FUNC(void, SFTY_INV_ACTR_CODE) SftyInvActr_ReinitMonrData(void)/* PRQA S 1503 # SftyInvActr_ReinitMonrData() is called by ErrDeb_cfg.c. */
 {
    /* ******** Variables declaration *********** */
    
'
