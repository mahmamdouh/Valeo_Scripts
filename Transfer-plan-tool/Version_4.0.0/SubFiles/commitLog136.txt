b'commit fb6c0f37e574b15f4308a68939363160a1719ea7
Author: Mohab MOSTAFA <mohab.mostafa@valeo.com>
Date:   Mon Nov 8 09:11:42 2021 +0200

    $100kW-45236$Update SWIT& SWIT_IT
    
    Change-Id: Ia0a4c8295ff21dd4779c87fd88a7c6cf0759581d

diff --git a/src/fw_cu/Components/Cmn/Com/C2cCom/src/C2cComDrvCtrl.c b/src/fw_cu/Components/Cmn/Com/C2cCom/src/C2cComDrvCtrl.c
index 8dd3be119..ddb62be13 100644
--- a/src/fw_cu/Components/Cmn/Com/C2cCom/src/C2cComDrvCtrl.c
+++ b/src/fw_cu/Components/Cmn/Com/C2cCom/src/C2cComDrvCtrl.c
@@ -303,7 +303,9 @@ FUNC(void, DRVCTRL_C2C_COM_CODE) DrvCtrlC2c_Send10ms(void)
    /* Convert absolute values to percentage values as per requirements (VW) */
    DrvCtrlC2cData.PerfIndcrCalcnTemp = CONST_PERCENT_CONV * PerfIndcrCalcnTemp;
    DrvCtrlC2cData.PerfIndcrCalcnPwr = CONST_PERCENT_CONV * PerfIndcrCalcnPwr;
-
+#ifdef SWIT_Active
+  SWIT_DrvCtrlC2c_Send10ms_EndHook();
+#endif
 }
 
 FUNC(void, DRVCTRL_C2C_COM_CODE) DrvCtrlC2c_Send128ms(void)
diff --git a/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/include/SWIT_DRCO.h b/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/include/SWIT_DRCO.h
index e4db9a21b..020244545 100644
--- a/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/include/SWIT_DRCO.h
+++ b/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/include/SWIT_DRCO.h
@@ -70,7 +70,13 @@
 #define DrvCtrlC2cData_InvEmTempAct_AcI2tCntr2_Output_Key       (8019)
 #define SWIT_DrvCtrlC2cData_CooltTemp_Output_Key                (8020)
 #define SWIT_SigWr_CooltFlowReq_Output_Key                      (8021)
-
+/*NVM Hook enable keys*/
+#define SWIT_NVM_SyncWriteAll_Key              (30501)
+/*#define SWIT_DrvCtrlC2cData_EMStatorTemp_Output_Key             (30502)
+#define SWIT_DrvCtrlC2cData_DcLinkTemp_Output_Key               (30503)
+#define SWIT_DrvCtrlC2cData_DcBusbarTemp_Output_Key             (30504)
+#define SWIT_DrvCtrlC2cData_HvAcI2tCntrAct1_Output_Key          (30505)
+#define SWIT_DrvCtrlC2cData_HvDcI2tCntrAct1_Output_Key          (30506)*/
 
 /*HvDcI Keys*/
 #define SWIT_IvtrThermMdlIvtrTotPwrLoss_Output_KEY (9050)
diff --git a/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/src/SWIT_DRCO.c b/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/src/SWIT_DRCO.c
index 6d0cee1f4..a8c44ca7a 100644
--- a/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/src/SWIT_DRCO.c
+++ b/src/fw_cu/Components/Cmn/SWIT/SWIT_DRCO/src/SWIT_DRCO.c
@@ -426,6 +426,16 @@
  void SWIT_DrvCtrlC2c_Send10ms_EndHook(void)
  {
     SWIT_DRCO_Set(&DrvCtrlC2cData.EMRotorTemp,SWIT_DrvCtrlC2cData_EMRotorTemp_Output_Key,SWIT_FLOAT32);
+/*Write values which will be saved in the NVM blocks*/
+    if((SWIT_DRCO_INTERFACES_MAIN_KEY_ENABLE==SWIT_DRCO_Interfaces_Main_key)&&(SWIT_NVM_SyncWriteAll_Key==SWIT_DRCO_Interface_Output_key))
+    {
+       DrvCtrlC2cData.InvTempAct.EmTemp1=150;
+       DrvCtrlC2cData.InvTempAct.EmTemp2=200;
+       DrvCtrlC2cData.InvTempAct.DcLinkCpTemp=100;
+       DrvCtrlC2cData.InvTempAct.DcBusBarTemp=-20;
+       DrvCtrlC2cData.InvTempAct.AcI2tCntr1=300;
+       DrvCtrlC2cData.InvTempAct.DcLinkI2tCntr1=250;
+    }
  }
 /*CanCom Functions End*/
 
diff --git a/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/include/SWIT_Sfty.h b/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/include/SWIT_Sfty.h
index ad1a94f7d..f43ee69a1 100644
--- a/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/include/SWIT_Sfty.h
+++ b/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/include/SWIT_Sfty.h
@@ -2241,6 +2241,7 @@
 #define SWIT_SftyHvInterlock_EN_KEY 20107
 #define SWIT_SftyE2eInterlockEvt_Input_KEY 20108
 #define SftyHvInterlockVadcLstTiStamp_Input_KEY 20109
+#define SftyHvInterlockMonrStsToVeh_Output_KEY 20110
 #define SftyE2eFpgaCtrlBrdRawVal_Output_KEY  30042
 #define SftyE2eFpgaDrvBrdRawVal_Output_KEY   30043
 #define SftyErrDebFctInhbnSts_B_FctIdActvDcha_Input_KEY 20302
@@ -2275,6 +2276,7 @@
 #define SWIT_sftyTempEvlnPhaIU_Input_KEY  20200
 #define SWIT_sftyTempEvlnPhaIV_Input_KEY 20202
 #define SWIT_sftyTempEvlnPhaIW_Input_KEY 20204
+#define SWIT_SftyAcEvlnPlausErrMonrSt_Output_KEY 20251
 #endif
 
 
@@ -3054,7 +3056,8 @@ extern void SWIT_SftyTqMon_GetQmTqAct_BgnHook(void);
 /*STOP of DetmnSafeTq System function*/
 
 /*Start of DetmnHvAcI System function*/
-
+/*extern void SWIT_SftyAcEvln_MainFunctionAreaCmn_EndHook(void);*/
+extern void SWIT_SftyRslvrEvln_CalcAtan_EndHook(void);
 /*STOP of DetmnHvAcI System function*/
 
 
@@ -3106,7 +3109,7 @@ extern void SWIT_SftySdl_Init_BgnHook (void);
 extern void SWIT_SftySpdMon_SpdPlaus_BgnHook(void);
 
 extern void SWIT_SftySpdMon_AgPlaus_BgnHook(void);
-
+extern void SWIT_SftyAcEvln_MainFunctionAreaCmn_EndHook(void);
 
 
 
@@ -3365,6 +3368,7 @@ extern void SWIT_SftyDcEvln_AscTogFltPuEvln_EndHook(void);
 extern void SWIT_SftyDcEvln_OCPStrtUpDiag_EndHook(void);
 extern void SWIT_SftyDcEvln_MainFunctionArea1Slow_EndHook(void);
 extern void SWIT_SftyDcEvln_MainFunctionArea1_EndHook(void);
+extern void SWIT_SftyRslvrEvln_MainFunctionArea1_EndHook(void);
 extern void SWIT_SftyTqEstimrPwrMdlPsFeLossCalc_EndHook(void);
 
 /*Extern 100 kw project for interface testing activity*/
@@ -3469,9 +3473,7 @@ extern void SftyHvInterlock_PassiveSigChk_EndHook(void);
 extern void SWIT_SftySbcCtrl_MainFunction_EndHook(void);
 extern void SWIT_SftyDcEvln_AscTogFltCuEvln_EndHook(void);
 extern void SWIT_SftyHvInterlock_MainFunction_EndHook(void);
-
-/*RotorSpeedAngleHooks*/
-extern void SWIT_SftyRslvrEvln_MainFunctionArea2_EndHook(void);
+extern void SWIT_SftyHvInterlock_UpdtCanSts_EndHook(void);
 #define SWIT_SFTY_AREA_2_STOP_SEC_CODE_SLOW
 #include "SWIT_MemMap.h"
 /***************End of ASIL B Functions***********************/
@@ -3481,7 +3483,7 @@ extern void SWIT_SftyRslvrEvln_MainFunctionArea2_EndHook(void);
 #define SWIT_SFTY_AREA_3_START_SEC_CODE_SLOW
 #include "SWIT_MemMap.h"
 extern void SWIT_SftyAcEvln_PlausReinitMonrData_EndHook(void);
-
+extern void SWIT_SftyAcEvln_PlausReinitMonrData_BgnHook(void);
 extern void SWIT_SftyErrDeb_MainFunctionAreaCmn_BgnHook (void);
 extern void BswC2c_E2eTxIndication_BgnHook(void);
 extern void Bsw2C2c_E2eRxIndication_BgnHook(void);
diff --git a/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_Area2.c b/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_Area2.c
index 26bf948c6..9e4378e3f 100644
--- a/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_Area2.c
+++ b/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_Area2.c
@@ -345,6 +345,7 @@ if(SWIT_Interface_Input_key==SftyHvInterlockVadcLstTiStamp_Input_KEY)
 #include "TestHooks.h"
 #include "SftyErrDeb.h"
 #include "SftyHvInterlock_data.h"
+#include "SftyErrDeb_data.h "
 ///********Function calls*********/
 /***************Start of ASIL B Functions***********************/
 #define SWIT_SFTY_AREA_2_START_SEC_CODE_SLOW
@@ -522,13 +523,13 @@ void SWIT_SftyAcEvln_MainFunctionArea2_EndHook(void)
 void SWIT_SftySbcCtrl_MainFunction_EndHook(void)
 {
    SWIT_Sfty_Check_Input(&SftyShutoffPahTstFS0bReq, SWIT_SftyShutoffPahTstFS0bReq_Input_KEY, SWIT_UINT8);
-   SWIT_Sfty_Set(&SftySbcCtrlComErrMonrSt, SWIT_SftySbcCtrlComErrMonrSt_Output_KEY, SWIT_UINT8);
+   //SWIT_Sfty_Set(&SftySbcCtrlComErrMonrSt, SWIT_SftySbcCtrlComErrMonrSt_Output_KEY, SWIT_UINT8);
   // SWIT_Sfty_Set(&SftySbcCtrlKl15Sts, SWIT_SftySbcCtrlKl15Sts_Output_KEY, SWIT_UINT8);
 //   SWIT_Sfty_Check_Input(&SftyShutoffPahTstSt, SWIT_SftyShutoffPahTstSt_Input_KEY, SWIT_UINT8);
 //   SWIT_Sfty_Set(&SftySbcCtrlDeactvtFS0bIsFinished, SWIT_SftySbcCtrlDeactvtFS0bIsFinished_Output_KEY, SWIT_UINT8);
    SWIT_Sfty_Set(&SftyC2cData.StsSbcFs0b,SWIT_SftyC2cData_StsSbcFs0b_Output_KEY,SWIT_UINT8);
  //  SWIT_Sfty_Set(&SftySbcCtrlFS0bReqdSt,SWIT_SftySbcCtrlFS0bReqdSt_Output_KEY,SWIT_UINT8);
-   SWIT_Sfty_Set(&SftySbcCtrlFs0bErrMonrSt,SWIT_SftySbcCtrlFs0bErrMonrSt_Output_KEY,SWIT_UINT8);
+   //SWIT_Sfty_Set(&SftySbcCtrlFs0bErrMonrSt,SWIT_SftySbcCtrlFs0bErrMonrSt_Output_KEY,SWIT_UINT8);
 }
 void SWIT_SftyDcEvln_MainFunctionArea2Slow_EndHook(void){
    SWIT_Sfty_Set(&SftyC2cData.Kl30UFromSbc,SWIT_SftyC2cData_Kl30UFromSbc_Output_KEY,SWIT_FLOAT32);
@@ -548,6 +549,11 @@ void SWIT_SftyHvInterlock_MainFunction_EndHook(void){
    SWIT_Sfty_Set(&SftyHvInterlockTiErrMonrSt,SftyHvInterlockTiErrMonrSt_Output_KEY,SWIT_UINT8);
 
 }
+
+void SWIT_SftyHvInterlock_UpdtCanSts_EndHook(void)
+{
+   SWIT_Sfty_Set(&SftyHvInterlockMonrStsToVeh,SftyHvInterlockMonrStsToVeh_Output_KEY,SWIT_UINT8);
+}
 #define SWIT_SFTY_AREA_2_STOP_SEC_CODE_SLOW
 #include "SWIT_MemMap.h"
 
diff --git a/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_AreaCMN.c b/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_AreaCMN.c
index deaf03857..7d9255373 100644
--- a/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_AreaCMN.c
+++ b/src/fw_cu/Components/Cmn/SWIT/SWIT_SFTY/src/SWIT_SFTY_AreaCMN.c
@@ -433,7 +433,14 @@ void SWIT_SftyModMgr_SepicOffDiag_EndHook(void)
 /*END of ActeSafeSt System function*/
 
 
+void SWIT_SftyModMgr_HndlKl15_EndHook(void){
+   SWIT_Sfty_Input_hook_uint8=P32_IN.B.P2;
+}
 
+void SWIT_SftyModMgr_SbcSleepModeHndlr_EndHook(void)
+{
+   SWIT_Sfty_Input_hook_uint8=MODULE_P00.OUT.B.P1;
+}
 /*************Stop of EndHook Function*************/
 
 #define SWIT_SFTY_AREA_3_STOP_SEC_CODE_SLOW
@@ -442,15 +449,7 @@ void SWIT_SftyModMgr_SepicOffDiag_EndHook(void)
 #define SWIT_SFTY_AREA_3_START_SEC_CODE_FAST
 #include "SWIT_MemMap.h"
 
-void SWIT_SftyModMgr_HndlKl15_EndHook(void){
-
-   SWIT_Sfty_Input_hook_uint8=P32_IN.B.P2;
-}
 
-void SWIT_SftyModMgr_SbcSleepModeHndlr_EndHook(void)
-{
-   SWIT_Sfty_Input_hook_uint8=MODULE_P00.OUT.B.P1;
-}
 #define SWIT_SFTY_AREA_3_STOP_SEC_CODE_FAST
 #include "SWIT_MemMap.h"
 #endif
@@ -659,6 +658,7 @@ void SWIT_SftyInvActr_ReinitMonrData_EndHook(void)
 \t SWIT_Sfty_Set(&SftyAcEvlnPhaseUOcHWErrMonrSt, SWIT_SftyAcEvlnPhaseUOcHWErrMonrSt_Output_KEY, SWIT_UINT8);
 \t SWIT_Sfty_Set(&SftyAcEvlnPhaseVOcHWErrMonrSt, SWIT_SftyAcEvlnPhaseVOcHWErrMonrSt_Output_KEY, SWIT_UINT8);
 \t SWIT_Sfty_Set(&SftyAcEvlnPhaseWOcHWErrMonrSt, SWIT_SftyAcEvlnPhaseWOcHWErrMonrSt_Output_KEY, SWIT_UINT8);
+\t SWIT_Sfty_Set(&SftyAcEvlnPlausErrMonrSt ,SWIT_SftyAcEvlnPlausErrMonrSt_Output_KEY ,SWIT_UINT8);
  }
 
 
@@ -1050,9 +1050,35 @@ void SWIT_SftyE2eFpga_ExtrMx1Data_EndHook(void)
 
 void SWIT_SftyAcEvln_PlausReinitMonrData_EndHook(void)
 {
-   SWIT_Sfty_Set(&SftyAcEvlnSetPlausReinitSt, SftyAcEvlnSetPlausReinitSt_Output_KEY, SWIT_UINT8);
+   if(SWIT_Sfty_Output_hook_uint8_Calib==0&&SWIT_SFTY_Interfaces_Main_key==1&&SWIT_Sfty_Output_hook_uint8==0)
+   {
+      SWIT_Sfty_Output_hook_uint8=1;
+      SWIT_Sfty_Set(&SftyAcEvlnSetPlausReinitSt, SftyAcEvlnSetPlausReinitSt_Output_KEY, SWIT_UINT8);
+   }
+
+   else if (SWIT_Sfty_Output_hook_uint8_Calib==1&&SWIT_SFTY_Interfaces_Main_key==1&&SWIT_Sfty_Output_hook_uint8==3)
+   {
+      SWIT_Sfty_Output_hook_uint8=1;
+      SWIT_Sfty_Set(&SftyAcEvlnSetPlausReinitSt, SftyAcEvlnSetPlausReinitSt_Output_KEY, SWIT_UINT8);
+   }
+
+
+
 
-   SWIT_Sfty_Check_Input(&SftyAcEvlnSetPlausReinitSt, SftyAcEvlnSetPlausReinitSt_Input_KEY, SWIT_UINT8_N);
+}
+void SWIT_SftyAcEvln_PlausReinitMonrData_BgnHook(void)
+{
+   if(SWIT_Sfty_Output_hook_uint8==2)
+     {
+      SWIT_Sfty_Check_Input(&SftyAcEvlnSetPlausReinitSt, SftyAcEvlnSetPlausReinitSt_Input_KEY, SWIT_UINT8_N);
+      if(SWIT_Sfty_Output_hook_uint8_Calib==0)
+      {
+      SWIT_Sfty_Output_hook_uint8=3;
+      }
+      else{
+         SWIT_Sfty_Output_hook_uint8=0;
+      }
+      }
 }
 void SWIT_SftyE2eFpga_MainFunction_BgnHook(void)
 {
@@ -1188,7 +1214,11 @@ void SWIT_SftyRslvrCalcn_SpdComp_EndHook(void){
 
 }
 
+/*void SWIT_SftyAcEvln_MainFunctionAreaCmn_EndHook(void)
+{
+   SWIT_Sfty_Set(&SftyAcEvlnPlausErrMonrSt ,SWIT_SftyAcEvlnPlausErrMonrSt_Output_KEY ,SWIT_UINT8);
 
+}*/
 #define SWIT_SFTY_AREA_3_STOP_SEC_CODE_SLOW
 #include "SWIT_MemMap.h"
 
diff --git a/src/fw_cu/Components/Safety/Sfty_Cmn/SftyModMgr/src/SftyModMgr.c b/src/fw_cu/Components/Safety/Sfty_Cmn/SftyModMgr/src/SftyModMgr.c
index 0632e170a..d3410a6dd 100644
--- a/src/fw_cu/Components/Safety/Sfty_Cmn/SftyModMgr/src/SftyModMgr.c
+++ b/src/fw_cu/Components/Safety/Sfty_Cmn/SftyModMgr/src/SftyModMgr.c
@@ -860,7 +860,12 @@ ErrDeb_FltStsType   kl15DebSt;
       SftyC2cData.Kl15St = STS_KL15_ON;
    }
 
-
+#ifdef SWIT_Active
+      if(SWIT_First_HookEnableKey==SWIT_M_KEY_ON_PIN_EnableKey)
+      {
+         SWIT_SftyModMgr_HndlKl15_EndHook();
+      }
+#endif
 #ifdef SWIT_IT_Active
       SWIT_SftyModMgr_HndlKl15_EndHook();
 #endif
@@ -920,6 +925,12 @@ if((SWIT_SftyModMgr_EN_KEY==SWIT_First_HookEnableKey)||(SWIT_SftyModMgr_EN_KEY==
    /* Handle sleep mode */
    SftyModMgr_SbcSleepModeHndlr();
 
+#ifdef SWIT_Active
+   if(SWIT_First_HookEnableKey==SWIT_M_PW_Down_PIN_EnableKey)
+   {
+   SWIT_SftyModMgr_SbcSleepModeHndlr_EndHook();
+   }
+   #endif
    return;
 }
 
diff --git a/src/fw_cu/Components/Safety/Sfty_Inv/SftyAcEvln/src/SftyAcEvln.c b/src/fw_cu/Components/Safety/Sfty_Inv/SftyAcEvln/src/SftyAcEvln.c
index 31b7777ff..5fcc233a4 100644
--- a/src/fw_cu/Components/Safety/Sfty_Inv/SftyAcEvln/src/SftyAcEvln.c
+++ b/src/fw_cu/Components/Safety/Sfty_Inv/SftyAcEvln/src/SftyAcEvln.c
@@ -560,7 +560,11 @@ FUNC(void, SFTY_AC_EVLN_CODE) SftyAcEvln_MainFunctionArea2(void)
 
 
 #ifdef SWIT_Active
-   SWIT_SftySbcCtrl_MainFunction_EndHook();
+   if(SWIT_First_HookEnableKey==SWIT_SftySbcCtrl_EN_KEY){
+      SWIT_SftySbcCtrl_MainFunction_EndHook();
+   }
+
+
 #endif
 
 #ifdef SWIT_IT_Active
@@ -622,7 +626,10 @@ FUNC(void, SFTY_AC_EVLN_CODE) SftyAcEvln_MainFunctionAreaCmn(void)
    SWIT_SftyAcEvln_MainFunctionAreaCmn_BgnHook();
 #endif
 #ifdef SWIT_Active
-   SWIT_SftyAcEvln_MainFunctionAreaCmn_BgnHook();
+   if(SWIT_Second_HookEnableKey==SWIT_SftyAcEvln_EN_KEY)
+   {
+      SWIT_SftyAcEvln_MainFunctionAreaCmn_BgnHook();
+   }
 #endif
     /* Clear error status */
 \tSftyAcEvlnPlausErrMonrSt = ERR_DEB_MONR_STS_INACTIVE; 
diff --git a/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvInterlock/src/SftyHvInterlock.c b/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvInterlock/src/SftyHvInterlock.c
index a66a8ddc3..6a3c5da1f 100644
--- a/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvInterlock/src/SftyHvInterlock.c
+++ b/src/fw_cu/Components/Safety/Sfty_Inv/SftyHvInterlock/src/SftyHvInterlock.c
@@ -359,6 +359,9 @@ LOCAL_INLINE void SftyHvInterlock_UpdtCanSts(void)
    {
       /* Do nothing */
    }
+#ifdef SWIT_IT_Active
+  SWIT_SftyHvInterlock_UpdtCanSts_EndHook();
+   #endif
 
    return;
 }
'
